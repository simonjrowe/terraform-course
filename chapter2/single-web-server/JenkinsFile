pipeline {
    agent { label 'master' }

     parameters {
        password (name: 'AWS_ACCESS_KEY_ID')
        password (name: 'AWS_SECRET_ACCESS_KEY')
      }
     environment {
        AWS_ACCESS_KEY_ID = "${params.AWS_ACCESS_KEY_ID}"
        AWS_SECRET_ACCESS_KEY = "${params.AWS_SECRET_ACCESS_KEY}"
      }

stages {
        
        stage("Build") {
            steps { buildApp() }
		}
    }
}

def buildApp() {
	dir ('chapter2/single-web-server' ) {
	    bat "export AWS_ACCESS_KEY_ID=AKIAIAEWASNPPBNUZPDA"
        bat "export AWS_SECRET_ACCESS_KEY=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"
	    bat "terraform init"
	    bat "terraform apply -auto-approve"
	}
}